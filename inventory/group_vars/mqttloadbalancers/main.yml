---
cert:
  - mqtt.iot.home.brwyatt.net
  - mqtt.home.brwyatt.net
haproxy_resolvers:
  localdns:
    nameservers:
      dns1:
        host: "127.0.0.53"
        port: "53"
    options:
      accepted_payload_size: 8192
haproxy_frontends:
  stats:
    bind:
      port: 8404
    options:
      - "stats enable"
      - "stats uri /"
      - "stats refresh 5s"
  www-http:
    bind:
      port: 80
    options:
      - "http-request redirect scheme https code 301"
  www-https:
    bind:
      port: 443
      ssl_cert: "/etc/haproxy/certs/mqtt.iot.home.brwyatt.net.pem"
    backend: "https"
    options:
      - "http-request set-header X-Forwarded-Proto https"
  mqtt:
    mode: "tcp"
    bind:
      port: 1883
    backend: "mqtts"
    options:
      - "timeout client 180s"
  mqtts:
    mode: "tcp"
    bind:
      port: 8883
      ssl_cert: "/etc/haproxy/certs/mqtt.iot.home.brwyatt.net.pem"
    backend: "mqtts"
    options:
      - "timeout client 180s"
haproxy_backends:
  https:
    balance: "leastconn"
    options:
      - "cookie SERVER insert indirect nocache dynamic"
      - "dynamic-cookie-key RANDOMSECRET"
      - "default-server check check-ssl ssl ca-file /etc/ssl/certs/ca-certificates.crt"
      - "server-template web 1-5 _https._tcp.mqtt.iot.home.brwyatt.net resolvers localdns init-addr none"
  mqtts:
    balance: "leastconn"
    mode: "tcp"
    options:
      - "timeout server 180s"
      - "default-server check check-ssl ssl ca-file /etc/ssl/certs/ca-certificates.crt send-proxy"
      - "server-template mqtts 1-5 _mqtts._tcp.mqtt.iot.home.brwyatt.net resolvers localdns init-addr none"
