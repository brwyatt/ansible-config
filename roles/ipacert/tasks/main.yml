---
- name: Create Cert directory
  ansible.builtin.file:
    path: "{{ ipacert_cert_dir }}"
    state: directory
    owner: root
    group: root
    mode: '0755'
- name: Create Key directory
  ansible.builtin.file:
    path: "{{ ipacert_key_dir }}"
    state: directory
    owner: root
    group: root
    mode: '0750'
- name: "Request certificates IPA CA"
  ipacert:
    state: "{{ item.value['state'] | default('present') }}"
    cert_name: "{{ item.key }}"
    domain: "{{ item.value['domain'] | default(ansible_fqdn) }}"
    principal: "{{ item.value['principal'] | default(omit) }}"
    cert_path: "{{ item.value['cert_path'] | default(ipacert_cert_dir + '/' + item.key + '.crt') }}"
    key_path: "{{ item.value['key_path'] | default(ipacert_key_dir + '/' + item.key + '.key') }}"
  loop: "{{ ipacert_certs | dict2items }}"
  loop_control:
    label: "{{ item.key }}"
  become: true
